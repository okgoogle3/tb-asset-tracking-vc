{
  "entityType" : "RULE_CHAIN",
  "entity" : {
    "additionalInfo" : {
      "description" : ""
    },
    "configuration" : null,
    "debugMode" : false,
    "externalId" : {
      "entityType" : "RULE_CHAIN",
      "id" : "130bb840-bc77-11ef-b55e-d50e0e2ee017"
    },
    "firstRuleNodeId" : {
      "entityType" : "RULE_NODE",
      "id" : "764639a2-bdec-11ef-b55e-d50e0e2ee017"
    },
    "id" : {
      "entityType" : "RULE_CHAIN",
      "id" : "130bb840-bc77-11ef-b55e-d50e0e2ee017"
    },
    "name" : "update alert activity/alert type",
    "root" : false,
    "type" : "CORE"
  },
  "metaData" : {
    "connections" : [ {
      "fromIndex" : 0,
      "toIndex" : 1,
      "type" : "Success"
    }, {
      "fromIndex" : 1,
      "toIndex" : 2,
      "type" : "Success"
    }, {
      "fromIndex" : 2,
      "toIndex" : 18,
      "type" : "Success"
    }, {
      "fromIndex" : 3,
      "toIndex" : 4,
      "type" : "Success"
    }, {
      "fromIndex" : 4,
      "toIndex" : 10,
      "type" : "Success"
    }, {
      "fromIndex" : 5,
      "toIndex" : 0,
      "type" : "True"
    }, {
      "fromIndex" : 5,
      "toIndex" : 3,
      "type" : "False"
    }, {
      "fromIndex" : 6,
      "toIndex" : 5,
      "type" : "Success"
    }, {
      "fromIndex" : 7,
      "toIndex" : 8,
      "type" : "Success"
    }, {
      "fromIndex" : 8,
      "toIndex" : 9,
      "type" : "Success"
    }, {
      "fromIndex" : 9,
      "toIndex" : 15,
      "type" : "Success"
    }, {
      "fromIndex" : 10,
      "toIndex" : 11,
      "type" : "Success"
    }, {
      "fromIndex" : 11,
      "toIndex" : 12,
      "type" : "Success"
    }, {
      "fromIndex" : 12,
      "toIndex" : 13,
      "type" : "Success"
    }, {
      "fromIndex" : 14,
      "toIndex" : 17,
      "type" : "Success"
    }, {
      "fromIndex" : 15,
      "toIndex" : 16,
      "type" : "Success"
    }, {
      "fromIndex" : 16,
      "toIndex" : 14,
      "type" : "Success"
    }, {
      "fromIndex" : 18,
      "toIndex" : 3,
      "type" : "Success"
    } ],
    "firstNodeIndex" : 6,
    "nodes" : [ {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 84,
        "layoutY" : 540
      },
      "configuration" : {
        "tellFailureIfAbsent" : false,
        "fetchTo" : "METADATA",
        "clientAttributeNames" : [ ],
        "sharedAttributeNames" : [ ],
        "serverAttributeNames" : [ "areaAlarms" ],
        "latestTsKeyNames" : [ ],
        "getLatestValueWithTs" : false
      },
      "configurationVersion" : 1,
      "createdTime" : 0,
      "debugMode" : true,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "76461290-bdec-11ef-b55e-d50e0e2ee017"
      },
      "name" : "get counter",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.metadata.TbGetAttributesNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 85,
        "layoutY" : 616
      },
      "configuration" : {
        "scriptLang" : "TBEL",
        "jsScript" : "return {msg: msg, metadata: metadata, msgType: msgType};",
        "tbelScript" : "var areaAlarms;\n\nif (metadata.ss_areaAlarms == null) {\n    areaAlarms = {\n        \"zone\": {\n            \"inside\": [],\n            \"outside\": []\n        },\n        \"geofence\": {\n            \"inside\": [],\n            \"outside\": []\n        }\n    };\n} else {\n    areaAlarms = JSON.parse(metadata.ss_areaAlarms);\n}\n\nvar newMsg = {\n    areaAlarms: areaAlarms\n};\nvar alarmNames = areaAlarms[metadata.area][metadata.status];\nif (metadata.create == true) {\n    if (!alarmNames.contains(msg.name)) {\n        alarmNames.add(msg.name);\n    }\n\n} else {\n    alarmNames.remove(msg.name);\n\n}\n\nmetadata.alarm = JSON.stringify(msg);\nreturn {\n    msg: newMsg,\n    metadata: metadata,\n    msgType: \"POST_ATTRIBUTES_REQUEST\"\n};"
      },
      "configurationVersion" : 0,
      "createdTime" : 0,
      "debugMode" : true,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "76461291-bdec-11ef-b55e-d50e0e2ee017"
      },
      "name" : "change counter",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.transform.TbTransformMsgNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 86,
        "layoutY" : 701
      },
      "configuration" : {
        "scope" : "SERVER_SCOPE",
        "notifyDevice" : false,
        "sendAttributesUpdatedNotification" : false,
        "updateAttributesOnlyOnValueChange" : true
      },
      "configurationVersion" : 2,
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "76461292-bdec-11ef-b55e-d50e0e2ee017"
      },
      "name" : "save attributes",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 491,
        "layoutY" : 778
      },
      "configuration" : {
        "alarmsCountMappings" : [ {
          "target" : "totalActiveAlarms",
          "typesList" : [ ],
          "severityList" : [ ],
          "statusList" : [ "ACTIVE_UNACK", "ACTIVE_ACK" ]
        }, {
          "target" : "temperatureAlarms",
          "typesList" : [ "Temperature is high", "Temperature is low", "Temperature is equal" ],
          "severityList" : [ ],
          "statusList" : [ "ACTIVE_UNACK", "ACTIVE_ACK" ]
        }, {
          "target" : "BatteryAlarms",
          "typesList" : [ "Battery level is high", "Battery level is low", "Battery level is equal" ],
          "severityList" : [ ],
          "statusList" : [ "ACTIVE_UNACK", "ACTIVE_ACK" ]
        }, {
          "target" : "MovementAlarms",
          "typesList" : [ "Movement detected" ],
          "severityList" : [ ],
          "statusList" : [ "ACTIVE_UNACK", "ACTIVE_ACK" ]
        }, {
          "target" : "IdleAlarms",
          "typesList" : [ "Device is standing still" ],
          "severityList" : [ ],
          "statusList" : [ "ACTIVE_UNACK", "ACTIVE_ACK" ]
        } ],
        "countAlarmsForPropagationEntities" : false,
        "propagationEntityTypes" : [ ],
        "outMsgType" : "POST_ATTRIBUTES_REQUEST"
      },
      "configurationVersion" : 2,
      "createdTime" : 0,
      "debugMode" : true,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "76461293-bdec-11ef-b55e-d50e0e2ee017"
      },
      "name" : "count alarms",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.analytics.latest.alarm.TbAlarmsCountNodeV2"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 490,
        "layoutY" : 854
      },
      "configuration" : {
        "tellFailureIfAbsent" : false,
        "fetchTo" : "METADATA",
        "clientAttributeNames" : [ ],
        "sharedAttributeNames" : [ ],
        "serverAttributeNames" : [ "areaAlarms" ],
        "latestTsKeyNames" : [ ],
        "getLatestValueWithTs" : false
      },
      "configurationVersion" : 1,
      "createdTime" : 0,
      "debugMode" : true,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "764639a0-bdec-11ef-b55e-d50e0e2ee017"
      },
      "name" : "get areaAlarms",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.metadata.TbGetAttributesNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 53,
        "layoutY" : 310
      },
      "configuration" : {
        "messageNames" : [ ],
        "metadataNames" : [ "area", "status" ],
        "checkAllKeys" : true
      },
      "configurationVersion" : 0,
      "createdTime" : 0,
      "debugMode" : true,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "764639a1-bdec-11ef-b55e-d50e0e2ee017"
      },
      "name" : "check if area alarm",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.filter.TbCheckMessageNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 50,
        "layoutY" : 227
      },
      "configuration" : {
        "version" : 0
      },
      "configurationVersion" : 1,
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "764639a2-bdec-11ef-b55e-d50e0e2ee017"
      },
      "name" : "SequentialByOriginator",
      "queueName" : "SequentialByOriginator",
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.flow.TbCheckpointNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 979,
        "layoutY" : 820
      },
      "configuration" : {
        "scriptLang" : "TBEL",
        "jsScript" : "return {msg: msg, metadata: metadata, msgType: msgType};",
        "tbelScript" : "areaAlarms = msg.areaAlarms;\n\nvar alertActivity = msg.totalActiveAlarms > 0;\nvar alertTypes = [];\nif(msg.temperatureAlarms>0){\n    alertTypes.add(\"Temperature\");\n}\nif(msg.BatteryAlarms>0){\n    alertTypes.add(\"Battery level\");\n}\nif(msg.MovementAlarms>0){\n    alertTypes.add(\"Moving\");\n}\nif(msg.IdleAlarms>0){\n    alertTypes.add(\"Idle\");\n}\n\nif(areaAlarms.zone.inside.length>0){\n    alertTypes.add(\"Zone in\");\n}\nif(areaAlarms.zone.outside.length>0){\n    alertTypes.add(\"Zone out\");\n}\n\n\n\nvar newMsg = {\n    alertActivity: alertActivity,\n    alertTypes: JSON.stringify(alertTypes)\n};\nreturn {\n    msg: newMsg,\n    metadata: metadata,\n    msgType: msgType\n};"
      },
      "configurationVersion" : 0,
      "createdTime" : 0,
      "debugMode" : true,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "764639a3-bdec-11ef-b55e-d50e0e2ee017"
      },
      "name" : "build alertTypes /alertActivity",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.transform.TbTransformMsgNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 985,
        "layoutY" : 905
      },
      "configuration" : {
        "originatorSource" : "RELATED",
        "preserveOriginatorIfCustomer" : false,
        "entityType" : null,
        "entityNamePattern" : null,
        "relationsQuery" : {
          "fetchLastLevelOnly" : false,
          "direction" : "TO",
          "maxLevel" : 1,
          "filters" : [ {
            "relationType" : "DeviceToAsset",
            "entityTypes" : [ "ASSET" ]
          } ]
        }
      },
      "configurationVersion" : 1,
      "createdTime" : 0,
      "debugMode" : true,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "764639a4-bdec-11ef-b55e-d50e0e2ee017"
      },
      "name" : "to asset",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 983,
        "layoutY" : 996
      },
      "configuration" : {
        "scope" : "SERVER_SCOPE",
        "notifyDevice" : false,
        "sendAttributesUpdatedNotification" : false,
        "updateAttributesOnlyOnValueChange" : true
      },
      "configurationVersion" : 2,
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "764639a5-bdec-11ef-b55e-d50e0e2ee017"
      },
      "name" : "save attributes",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 491,
        "layoutY" : 940
      },
      "configuration" : {
        "scriptLang" : "TBEL",
        "jsScript" : "return {msg: msg, metadata: metadata, msgType: msgType};",
        "tbelScript" : "var areaAlarms;\n\nif (metadata.ss_areaAlarms == null || msg.totalActiveAlarms == 0 ) {\n    areaAlarms = {\n        \"zone\": {\n            \"inside\": [],\n            \"outside\": []\n        },\n        \"geofence\": {\n            \"inside\": [],\n            \"outside\": []\n        }\n    };\n} else {\n    areaAlarms = JSON.parse(metadata.ss_areaAlarms);\n}\n\n\nreturn {\n    msg: msg,\n    metadata: {\n        areaAlarms : JSON.stringify(areaAlarms)\n    },\n    msgType: \"POST_ATTRIBUTES_REQUEST\"\n};"
      },
      "configurationVersion" : 0,
      "createdTime" : 0,
      "debugMode" : true,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "764639a6-bdec-11ef-b55e-d50e0e2ee017"
      },
      "name" : "change counter",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.transform.TbTransformMsgNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 480,
        "layoutY" : 1025
      },
      "configuration" : {
        "scriptLang" : "TBEL",
        "jsScript" : "return {msg: msg, metadata: metadata, msgType: msgType};",
        "tbelScript" : "areaAlarms = JSON.parse(metadata.areaAlarms);\n\nvar alertActivity = msg.totalActiveAlarms > 0;\nvar alertTypes = [];\nif(msg.temperatureAlarms>0){\n    alertTypes.add(\"Temperature\");\n}\nif(msg.BatteryAlarms>0){\n    alertTypes.add(\"Battery level\");\n}\nif(msg.MovementAlarms>0){\n    alertTypes.add(\"Moving\");\n}\nif(msg.IdleAlarms>0){\n    alertTypes.add(\"Idle\");\n}\n\nif(areaAlarms.zone.inside.length>0){\n    alertTypes.add(\"Zone in\");\n}\nif(areaAlarms.zone.outside.length>0){\n    alertTypes.add(\"Zone out\");\n}\n\n\n\nvar newMsg = {\n    alertActivity: alertActivity,\n    alertTypes: JSON.stringify(alertTypes)\n};\nreturn {\n    msg: newMsg,\n    metadata: metadata,\n    msgType: msgType\n};"
      },
      "configurationVersion" : 0,
      "createdTime" : 0,
      "debugMode" : true,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "764660b0-bdec-11ef-b55e-d50e0e2ee017"
      },
      "name" : "build alertTypes /alertActivity",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.transform.TbTransformMsgNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 482,
        "layoutY" : 1107
      },
      "configuration" : {
        "originatorSource" : "RELATED",
        "preserveOriginatorIfCustomer" : false,
        "entityType" : null,
        "entityNamePattern" : null,
        "relationsQuery" : {
          "fetchLastLevelOnly" : false,
          "direction" : "TO",
          "maxLevel" : 1,
          "filters" : [ {
            "relationType" : "DeviceToAsset",
            "entityTypes" : [ "ASSET" ]
          } ]
        }
      },
      "configurationVersion" : 1,
      "createdTime" : 0,
      "debugMode" : true,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "764660b1-bdec-11ef-b55e-d50e0e2ee017"
      },
      "name" : "to asset",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 480,
        "layoutY" : 1198
      },
      "configuration" : {
        "scope" : "SERVER_SCOPE",
        "notifyDevice" : false,
        "sendAttributesUpdatedNotification" : false,
        "updateAttributesOnlyOnValueChange" : true
      },
      "configurationVersion" : 2,
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "764660b2-bdec-11ef-b55e-d50e0e2ee017"
      },
      "name" : "save attributes",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 970,
        "layoutY" : 1252
      },
      "configuration" : {
        "alarmsCountMappings" : [ {
          "target" : "totalActiveAlarms",
          "typesList" : [ ],
          "severityList" : [ ],
          "statusList" : [ "ACTIVE_UNACK", "ACTIVE_ACK" ]
        }, {
          "target" : "temperatureAlarms",
          "typesList" : [ "Temperature is high", "Temperature is low", "Temperature is equal" ],
          "severityList" : [ ],
          "statusList" : [ "ACTIVE_UNACK", "ACTIVE_ACK" ]
        }, {
          "target" : "BatteryAlarms",
          "typesList" : [ "Battery level is high", "Battery level is low", "Battery level is equal" ],
          "severityList" : [ ],
          "statusList" : [ "ACTIVE_UNACK", "ACTIVE_ACK" ]
        }, {
          "target" : "MovementAlarms",
          "typesList" : [ "Movement detected" ],
          "severityList" : [ ],
          "statusList" : [ "ACTIVE_UNACK", "ACTIVE_ACK" ]
        }, {
          "target" : "IdleAlarms",
          "typesList" : [ "Device is standing still" ],
          "severityList" : [ ],
          "statusList" : [ "ACTIVE_UNACK", "ACTIVE_ACK" ]
        } ],
        "countAlarmsForPropagationEntities" : false,
        "propagationEntityTypes" : [ ],
        "outMsgType" : "POST_ATTRIBUTES_REQUEST"
      },
      "configurationVersion" : 2,
      "createdTime" : 0,
      "debugMode" : true,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "764660b3-bdec-11ef-b55e-d50e0e2ee017"
      },
      "name" : "count alarms",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.analytics.latest.alarm.TbAlarmsCountNodeV2"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 976,
        "layoutY" : 1083
      },
      "configuration" : {
        "originatorSource" : "RELATED",
        "preserveOriginatorIfCustomer" : false,
        "entityType" : null,
        "entityNamePattern" : null,
        "relationsQuery" : {
          "fetchLastLevelOnly" : false,
          "direction" : "FROM",
          "maxLevel" : 1,
          "filters" : [ {
            "relationType" : "DeviceToAsset",
            "entityTypes" : [ "DEVICE" ]
          } ]
        }
      },
      "configurationVersion" : 1,
      "createdTime" : 0,
      "debugMode" : true,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "764660b4-bdec-11ef-b55e-d50e0e2ee017"
      },
      "name" : "to device",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 968,
        "layoutY" : 1171
      },
      "configuration" : {
        "copyFrom" : "METADATA",
        "keys" : [ "alarm" ]
      },
      "configurationVersion" : 2,
      "createdTime" : 0,
      "debugMode" : true,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "764660b5-bdec-11ef-b55e-d50e0e2ee017"
      },
      "name" : "copy",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.transform.TbCopyKeysNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 965,
        "layoutY" : 1340
      },
      "configuration" : {
        "scope" : "SERVER_SCOPE",
        "notifyDevice" : false,
        "sendAttributesUpdatedNotification" : false,
        "updateAttributesOnlyOnValueChange" : true
      },
      "configurationVersion" : 2,
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "764660b6-bdec-11ef-b55e-d50e0e2ee017"
      },
      "name" : "save attributes",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 85,
        "layoutY" : 783
      },
      "configuration" : {
        "scriptLang" : "TBEL",
        "jsScript" : "return {msg: msg, metadata: metadata, msgType: msgType};",
        "tbelScript" : "return {\n    msg: JSON.parse(metadata.alarm),\n    metadata: metadata,\n    msgType: \"ALARM\"\n};"
      },
      "configurationVersion" : 0,
      "createdTime" : 0,
      "debugMode" : true,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "479af6f0-bdf5-11ef-b55e-d50e0e2ee017"
      },
      "name" : "prepare msg for alarms count rule node",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.transform.TbTransformMsgNode"
    } ],
    "ruleChainConnections" : null
  },
  "attributes" : {
    "SERVER_SCOPE" : [ ]
  }
}