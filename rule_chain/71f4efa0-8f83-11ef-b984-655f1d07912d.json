{
  "entityType" : "RULE_CHAIN",
  "entity" : {
    "additionalInfo" : {
      "description" : ""
    },
    "configuration" : null,
    "debugMode" : false,
    "externalId" : null,
    "firstRuleNodeId" : {
      "entityType" : "RULE_NODE",
      "id" : "c51183e0-91f1-11ef-b984-655f1d07912d"
    },
    "id" : {
      "entityType" : "RULE_CHAIN",
      "id" : "71f4efa0-8f83-11ef-b984-655f1d07912d"
    },
    "name" : "Alarm rule chain",
    "root" : false,
    "type" : "CORE"
  },
  "metaData" : {
    "connections" : [ {
      "fromIndex" : 0,
      "toIndex" : 1,
      "type" : "Success"
    }, {
      "fromIndex" : 1,
      "toIndex" : 2,
      "type" : "True"
    }, {
      "fromIndex" : 1,
      "toIndex" : 3,
      "type" : "False"
    }, {
      "fromIndex" : 2,
      "toIndex" : 4,
      "type" : "Created"
    }, {
      "fromIndex" : 3,
      "toIndex" : 6,
      "type" : "False"
    }, {
      "fromIndex" : 4,
      "toIndex" : 13,
      "type" : "Success"
    }, {
      "fromIndex" : 5,
      "toIndex" : 11,
      "type" : "phone"
    }, {
      "fromIndex" : 5,
      "toIndex" : 12,
      "type" : "sms"
    }, {
      "fromIndex" : 6,
      "toIndex" : 13,
      "type" : "Success"
    }, {
      "fromIndex" : 7,
      "toIndex" : 10,
      "type" : "Success"
    }, {
      "fromIndex" : 8,
      "toIndex" : 9,
      "type" : "Success"
    }, {
      "fromIndex" : 11,
      "toIndex" : 8,
      "type" : "Success"
    }, {
      "fromIndex" : 12,
      "toIndex" : 7,
      "type" : "Success"
    }, {
      "fromIndex" : 13,
      "toIndex" : 14,
      "type" : "Success"
    }, {
      "fromIndex" : 14,
      "toIndex" : 15,
      "type" : "True"
    }, {
      "fromIndex" : 15,
      "toIndex" : 5,
      "type" : "Success"
    } ],
    "firstNodeIndex" : 17,
    "nodes" : [ {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 114,
        "layoutY" : 383
      },
      "configuration" : {
        "scriptLang" : "TBEL",
        "jsScript" : "return {msg: msg, metadata: metadata, msgType: msgType};",
        "tbelScript" : "var alarmSettings = JSON.parse(metadata.alarmSettings).profileSettings;\nvar alarmMsgs = [];\n\nforeach(setting: alarmSettings.variables.entrySet()) {\n    var keyName = setting.getKey();\n    var alarmRules = setting.getValue();\n\n    if (msg[keyName] == null || alarmRules == null ||\n        alarmRules.isEmpty()) {\n        break;\n    }\n\n    var alarmVariable = msg[keyName];\n\n    foreach(alarmRule: alarmRules) {\n        if (alarmRule.enabled == null || !alarmRule.enabled) {\n            break;\n        }\n\n        var isLower = alarmRule.lowThresholdValue != null ? alarmVariable < alarmRule.lowThresholdValue : null;\n        var isHigher = alarmRule.highThresholdValue != null ? alarmVariable > alarmRule.highThresholdValue : null;\n        var isCreate = isLower === true || isHigher === true;\n        var notificationSettings = JSON.stringify(alarmRule.notifications);\n\n        alarmMsgs.push({\n            msg: {\n                severity: alarmRule\n                    .severity,\n                alarmName: alarmRule\n                    .alarmName\n            },\n            metadata: {ts:metadata.ts,isCreate:isCreate,notifications:notificationSettings },\n            msgType: \"alarm\"\n        });\n    }\n\n\n}\n\nmsg.alarmSettings = alarmSettings;\n\n\nreturn alarmMsgs;"
      },
      "configurationVersion" : 0,
      "createdTime" : 0,
      "debugMode" : true,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "89612eb0-8f83-11ef-b984-655f1d07912d"
      },
      "name" : "check for alarms",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.transform.TbTransformMsgNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 111,
        "layoutY" : 480
      },
      "configuration" : {
        "scriptLang" : "TBEL",
        "jsScript" : "return msg.temperature > 20;",
        "tbelScript" : "return metadata.isCreate===true;"
      },
      "configurationVersion" : 0,
      "createdTime" : 0,
      "debugMode" : true,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "8961a3e0-8f83-11ef-b984-655f1d07912d"
      },
      "name" : "alarm switch",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.filter.TbJsFilterNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 384,
        "layoutY" : 484
      },
      "configuration" : {
        "scriptLang" : "TBEL",
        "alarmDetailsBuildJs" : "var details = {};\nif (metadata.prevAlarmDetails) {\n    details = JSON.parse(metadata.prevAlarmDetails);\n    //remove prevAlarmDetails from metadata\n    delete metadata.prevAlarmDetails;\n    //now metadata is the same as it comes IN this rule node\n}\n\n\nreturn details;",
        "alarmDetailsBuildTbel" : "var details = {};\nif (metadata.prevAlarmDetails != null) {\n    details = JSON.parse(metadata.prevAlarmDetails);\n    //remove prevAlarmDetails from metadata\n    metadata.remove('prevAlarmDetails');\n    //now metadata is the same as it comes IN this rule node\n}\n\n\nreturn details;",
        "useMessageAlarmData" : false,
        "overwriteAlarmDetails" : false,
        "alarmType" : "$[alarmName]",
        "severity" : "$[severity]",
        "propagate" : false,
        "relationTypes" : [ ],
        "propagateToOwner" : false,
        "propagateToOwnerHierarchy" : false,
        "propagateToTenant" : false,
        "dynamicSeverity" : true
      },
      "configurationVersion" : 0,
      "createdTime" : 0,
      "debugMode" : true,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "8961caf0-8f83-11ef-b984-655f1d07912d"
      },
      "name" : "create alarm",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.action.TbCreateAlarmNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 378,
        "layoutY" : 563
      },
      "configuration" : {
        "scriptLang" : "TBEL",
        "alarmDetailsBuildJs" : "var details = {};\nif (metadata.prevAlarmDetails) {\n    details = JSON.parse(metadata.prevAlarmDetails);\n    //remove prevAlarmDetails from metadata\n    delete metadata.prevAlarmDetails;\n    //now metadata is the same as it comes IN this rule node\n}\n\n\nreturn details;",
        "alarmDetailsBuildTbel" : "var details = {};\nif (metadata.prevAlarmDetails != null) {\n    details = JSON.parse(metadata.prevAlarmDetails);\n    //remove prevAlarmDetails from metadata\n    metadata.remove('prevAlarmDetails');\n    //now metadata is the same as it comes IN this rule node\n}\n\n\nreturn details;",
        "alarmType" : "$[alarmName]"
      },
      "configurationVersion" : 0,
      "createdTime" : 0,
      "debugMode" : true,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "89621910-8f83-11ef-b984-655f1d07912d"
      },
      "name" : "clear alarm",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.action.TbClearAlarmNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 675,
        "layoutY" : 484
      },
      "configuration" : {
        "scriptLang" : "TBEL",
        "jsScript" : "return {msg: msg, metadata: metadata, msgType: msgType};",
        "tbelScript" : "metadata.alarmCreated = true;\nreturn {msg: msg, metadata: metadata, msgType: msgType};"
      },
      "configurationVersion" : 0,
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "8ada4f40-8f85-11ef-b984-655f1d07912d"
      },
      "name" : "alarm created",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.transform.TbTransformMsgNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 1256,
        "layoutY" : 671
      },
      "configuration" : {
        "scriptLang" : "TBEL",
        "jsScript" : "function nextRelation(metadata, msg) {\n    return ['one','nine'];\n}\nif(msgType === 'POST_TELEMETRY_REQUEST') {\n    return ['two'];\n}\nreturn nextRelation(metadata, msg);",
        "tbelScript" : "var result = [];\nvar notifications = JSON.parse(metadata.notifications);\nif (notifications.sms === true) {\n    result.add(\"sms\");\n}\nif (notifications.email === true) {\n    result.add(\"email\");\n}\nif (notifications.web === true) {\n    result.add(\"web\");\n}\nreturn result;"
      },
      "configurationVersion" : 0,
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "8ada4f41-8f85-11ef-b984-655f1d07912d"
      },
      "name" : "notification switch",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.filter.TbJsSwitchNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 676,
        "layoutY" : 562
      },
      "configuration" : {
        "scriptLang" : "TBEL",
        "jsScript" : "return {msg: msg, metadata: metadata, msgType: msgType};",
        "tbelScript" : "metadata.alarmCreated = false;\nreturn {msg: msg, metadata: metadata, msgType: msgType};"
      },
      "configurationVersion" : 0,
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "99c5e3c0-8f85-11ef-b984-655f1d07912d"
      },
      "name" : "alarm cleared",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.transform.TbTransformMsgNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 1807,
        "layoutY" : 563
      },
      "configuration" : {
        "scriptLang" : "TBEL",
        "jsScript" : "return {msg: msg, metadata: metadata, msgType: msgType};",
        "tbelScript" : "return {msg: msg, metadata: metadata, msgType: msgType};"
      },
      "configurationVersion" : 0,
      "createdTime" : 0,
      "debugMode" : true,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "54af77f0-8f86-11ef-b984-655f1d07912d"
      },
      "name" : "prepare sms",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.transform.TbTransformMsgNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 1809,
        "layoutY" : 664
      },
      "configuration" : {
        "fromTemplate" : "info@testmail.org",
        "toTemplate" : "${userEmail}",
        "ccTemplate" : null,
        "bccTemplate" : null,
        "subjectTemplate" : "Device ${deviceType} temperature high",
        "bodyTemplate" : "Device ${deviceName} has high temperature $[temperature]",
        "isHtmlTemplate" : null,
        "mailBodyType" : "false"
      },
      "configurationVersion" : 0,
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "54af9f00-8f86-11ef-b984-655f1d07912d"
      },
      "name" : "prepare email",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.mail.TbMsgToEmailNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 2089,
        "layoutY" : 657
      },
      "configuration" : {
        "useSystemSmtpSettings" : true,
        "smtpHost" : "localhost",
        "smtpPort" : 25,
        "username" : null,
        "password" : null,
        "smtpProtocol" : "smtp",
        "timeout" : 10000,
        "enableTls" : false,
        "tlsVersion" : "TLSv1.2",
        "enableProxy" : false,
        "proxyHost" : null,
        "proxyPort" : null,
        "proxyUser" : null,
        "proxyPassword" : null
      },
      "configurationVersion" : 0,
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "54afed20-8f86-11ef-b984-655f1d07912d"
      },
      "name" : "send email",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.mail.TbSendEmailNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 2088,
        "layoutY" : 562
      },
      "configuration" : {
        "numbersToTemplate" : "${userPhone}",
        "smsMessageTemplate" : "Device ${deviceName} has high temperature ${temp}",
        "useSystemSmsSettings" : true,
        "smsProviderConfiguration" : null
      },
      "configurationVersion" : 0,
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "54afed21-8f86-11ef-b984-655f1d07912d"
      },
      "name" : "send sms",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.sms.TbSendSmsNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 1542,
        "layoutY" : 668
      },
      "configuration" : {
        "fetchTo" : "METADATA",
        "dataMapping" : {
          "name" : "originatorName",
          "type" : "originatorType"
        },
        "ignoreNullStrings" : false
      },
      "configurationVersion" : 1,
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "88c24f40-8f86-11ef-b984-655f1d07912d"
      },
      "name" : "get email",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.metadata.TbGetOriginatorFieldsNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 1540,
        "layoutY" : 563
      },
      "configuration" : {
        "dataMapping" : {
          "phone" : "originatorPhone"
        },
        "ignoreNullStrings" : false,
        "fetchTo" : "METADATA"
      },
      "configurationVersion" : 1,
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "88c24f41-8f86-11ef-b984-655f1d07912d"
      },
      "name" : "get phone",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.metadata.TbGetOriginatorFieldsNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 981,
        "layoutY" : 493
      },
      "configuration" : {
        "originatorSource" : "RELATED",
        "preserveOriginatorIfCustomer" : false,
        "entityType" : null,
        "entityNamePattern" : null,
        "relationsQuery" : {
          "fetchLastLevelOnly" : false,
          "direction" : "FROM",
          "maxLevel" : 1,
          "filters" : [ {
            "relationType" : "toAlarmConfig",
            "entityTypes" : [ "ASSET" ]
          } ]
        }
      },
      "configurationVersion" : 1,
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "92e402d0-8f8a-11ef-b984-655f1d07912d"
      },
      "name" : "toAlarmConfig",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 1255,
        "layoutY" : 491
      },
      "configuration" : {
        "checkForSingleEntity" : false,
        "direction" : "FROM",
        "entityType" : null,
        "entityId" : null,
        "relationType" : "fromAlarmConfigAssetToInformingUser"
      },
      "configurationVersion" : 1,
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "92e429e0-8f8a-11ef-b984-655f1d07912d"
      },
      "name" : "check if there are users to be informed",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.filter.TbCheckRelationNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 1257,
        "layoutY" : 575
      },
      "configuration" : {
        "relationsQuery" : {
          "direction" : "FROM",
          "maxLevel" : 1,
          "filters" : [ {
            "relationType" : "Contains",
            "entityTypes" : [ ],
            "negate" : false
          } ],
          "fetchLastLevelOnly" : false
        }
      },
      "configurationVersion" : 0,
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "92e450f0-8f8a-11ef-b984-655f1d07912d"
      },
      "name" : "duplicate to informing users",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.transform.TbDuplicateMsgToRelatedNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 714,
        "layoutY" : 211
      },
      "configuration" : {
        "msgCount" : 1,
        "periodInSeconds" : 2,
        "scriptLang" : "TBEL",
        "jsScript" : "var msg = { temp: 42, humidity: 77 };\nvar metadata = { data: 40 };\nvar msgType = \"POST_TELEMETRY_REQUEST\";\n\nreturn { msg: msg, metadata: metadata, msgType: msgType };",
        "tbelScript" : "var msg = {\n    temperature: 8,\n    battery: 3.9\n\n};\nvar metadata = {test:123};\nvar msgType = \"POST_TELEMETRY_REQUEST\";\n\nreturn {\n    msg: msg,\n    metadata: metadata,\n    msgType: msgType\n};",
        "originatorId" : "ebf3bed0-8227-11ef-b5ef-a3c9386e22a5",
        "originatorType" : "ASSET"
      },
      "configurationVersion" : 1,
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "72422cd0-8fa5-11ef-b984-655f1d07912d"
      },
      "name" : "test",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.debug.TbMsgGeneratorNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 119,
        "layoutY" : 311
      },
      "configuration" : {
        "originatorSource" : "ENTITY",
        "preserveOriginatorIfCustomer" : false,
        "entityType" : "ASSET",
        "entityNamePattern" : "${assetName}",
        "relationsQuery" : {
          "fetchLastLevelOnly" : false,
          "direction" : "FROM",
          "maxLevel" : 1,
          "filters" : [ {
            "relationType" : "toAlarmConfig",
            "entityTypes" : [ "ASSET" ]
          } ]
        }
      },
      "configurationVersion" : 1,
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "c51183e0-91f1-11ef-b984-655f1d07912d"
      },
      "name" : "to asset",
      "queueName" : null,
      "ruleChainId" : null,
      "singletonMode" : false,
      "type" : "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode"
    } ],
    "ruleChainConnections" : null
  },
  "relations" : [ ],
  "attributes" : {
    "SERVER_SCOPE" : [ ]
  }
}